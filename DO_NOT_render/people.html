<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>人潮汹涌 Crowd Simulator</title><link rel="stylesheet" href="/css/people.css"></head><body><canvas id="canvas"></canvas><script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script></body><style>body,html{height:100%;background-color:#fff}body{margin:0}#canvas{width:100%;height:100%}body::-webkit-scrollbar{display:none}</style><script>const config={src:"https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/open-peeps-sheet.png",rows:15,cols:7},randomRange=(e,a)=>e+Math.random()*(a-e),randomIndex=e=>0|randomRange(0,e.length),removeFromArray=(e,a)=>e.splice(a,1)[0],removeItemFromArray=(e,a)=>removeFromArray(e,e.indexOf(a)),removeRandomFromArray=e=>removeFromArray(e,randomIndex(e)),getRandomFromArray=e=>e[0|randomIndex(e)],resetPeep=({stage:e,peep:a})=>{const t=Math.random()>.5?1:-1,r=100-250*gsap.parseEase("power2.in")(Math.random()),o=e.height-a.height+r;let s,i;return 1===t?(s=-a.width,i=e.width,a.scaleX=1):(s=e.width+a.width,i=0,a.scaleX=-1),a.x=s,a.y=o,a.anchorY=o,{startX:s,startY:o,endX:i}},normalWalk=({peep:e,props:a})=>{const{startX:t,startY:r,endX:o}=a,s=gsap.timeline();return s.timeScale(randomRange(.5,1.5)),s.to(e,{duration:10,x:o,ease:"none"},0),s.to(e,{duration:.25,repeat:40,yoyo:!0,y:r-10},0),s},walks=[normalWalk];class Peep{constructor({image:e,rect:a}){this.image=e,this.setRect(a),this.x=0,this.y=0,this.anchorY=0,this.scaleX=1,this.walk=null}setRect(e){this.rect=e,this.width=e[2],this.height=e[3],this.drawArgs=[this.image,...e,0,0,this.width,this.height]}render(e){e.save(),e.translate(this.x,this.y),e.scale(this.scaleX,1),e.drawImage(...this.drawArgs),e.restore()}}const img_crowd=document.createElement("img");img_crowd.onload=init,img_crowd.src=config.src;const canvas=document.querySelector("#canvas"),ctx=canvas.getContext("2d"),stage={width:0,height:0};var allPeeps=[];const availablePeeps=[],crowd=[];function init(){createPeeps(),resize(),gsap.ticker.add(render),window.addEventListener("resize",resize)}function createPeeps(){const{rows:e,cols:a}=config,{naturalWidth:t,naturalHeight:r}=img_crowd,o=e*a,s=t/e,i=r/a;for(let a=0;a<o;a++)allPeeps.push(new Peep({image:img_crowd,rect:[a%e*s,(a/e|0)*i,s,i]}))}function resize(){stage.width=canvas.clientWidth,stage.height=canvas.clientHeight,canvas.width=stage.width*devicePixelRatio,canvas.height=stage.height*devicePixelRatio,crowd.forEach((e=>{e.walk.kill()})),crowd.length=0,availablePeeps.length=0,availablePeeps.push(...allPeeps),initCrowd()}function initCrowd(){for(;availablePeeps.length;)addPeepToCrowd().walk.progress(Math.random())}function addPeepToCrowd(){const e=removeRandomFromArray(availablePeeps),a=getRandomFromArray(walks)({peep:e,props:resetPeep({peep:e,stage:stage})}).eventCallback("onComplete",(()=>{removePeepFromCrowd(e),addPeepToCrowd()}));return e.walk=a,crowd.push(e),crowd.sort(((e,a)=>e.anchorY-a.anchorY)),e}function removePeepFromCrowd(e){removeItemFromArray(crowd,e),availablePeeps.push(e)}function render(){canvas.width=canvas.width,ctx.save(),ctx.scale(devicePixelRatio,devicePixelRatio),crowd.forEach((e=>{e.render(ctx)})),ctx.restore()}</script></html>